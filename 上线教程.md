# 宝宝糖果消消乐 - 上线教程

本教程将帮助你：
1. **部署到网上**：使用 Cloudflare Pages 免费托管
2. **多人竞技实时分数**：使用 Firebase Realtime Database 实现同一暗号下多人分数实时同步

---

## 一、准备工作

- GitHub 账号（项目需推送到 GitHub）
- Google 账号（用于 Firebase）
- Cloudflare 账号（免费注册）

---

## 二、配置 Firebase（多人竞技实时分数）

多人竞技实时分数依赖 **Firebase Realtime Database**。同一暗号房间的玩家会看到彼此的分数实时更新。

### 2.1 创建 Firebase 项目

1. 打开 [Firebase 控制台](https://console.firebase.google.com/)
2. 点击 **创建项目** → 输入项目名称（如 `BaoBaoCandyCrush`）→ 按提示完成创建
3. 进入项目后，左侧 **Build** → **Realtime Database** → 点击 **创建数据库**
4. 选择地区：建议 `asia-southeast1`（新加坡，国内访问较稳定）
5. 安全规则：先选 **测试模式**（方便快速联调，上线前再改规则）

### 2.2 获取 Firebase 配置

1. 点击左侧齿轮 **项目设置** → **您的应用** → 点击 Web 图标 `</>`
2. 注册应用名称（如 `web`），不勾选 Firebase Hosting
3. 复制配置中的以下值（后面会用到）：
   - `apiKey`
   - `authDomain`（可选）
   - `databaseURL`（形如 `https://xxx-default-rtdb.asia-southeast1.firebasedatabase.app`）
   - `projectId`
   - `appId`

### 2.3 设置安全规则（上线前必做）

在 Realtime Database → **规则** 中，将规则改为：

```json
{
  "rules": {
    "rooms": {
      "$passcode": {
        "players": {
          ".read": true,
          ".write": true
        },
        "rankings": {
          ".read": true,
          ".write": true
        }
      }
    }
  }
}
```

这样只允许读写 `rooms` 下的数据，且按暗号隔离。

---

## 三、本地配置环境变量

在项目根目录创建 `.env.local` 文件（不要提交到 Git）：

```env
# Firebase 多人竞技实时分数（必填两项即可启用）
VITE_FIREBASE_API_KEY=你的apiKey
VITE_FIREBASE_DATABASE_URL=https://你的项目-default-rtdb.区域.firebasedatabase.app

# 可选，建议与控制台一致
VITE_FIREBASE_AUTH_DOMAIN=你的项目.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=你的projectId
VITE_FIREBASE_APP_ID=你的appId
```

**本地测试多人竞技**：

1. `npm install` 安装依赖
2. `npm run dev` 启动开发服务器
3. 用两个浏览器（或一个正常 + 一个隐身窗口）分别打开 `http://localhost:3000`
4. 使用**同一暗号**登录，进入游戏
5. 右侧 **实时榜单** 会显示双方分数，分数会实时同步更新

---

## 四、部署到 Cloudflare Pages

### 4.1 推送代码到 GitHub

```bash
git add .
git commit -m "准备部署"
git push origin main
```

### 4.2 在 Cloudflare 创建 Pages 项目

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 左侧 **Workers & Pages** → **Create** → **Pages** → **Connect to Git**
3. 选择 **GitHub**，授权并选择仓库 `BaoBaoCandyCrush`
4. 配置构建设置：
   - **Framework preset**: 选 **None** 或 **Vite**（若自动识别）
   - **Build command**: `npm run build`
   - **Build output directory**: `dist`
   - **Root directory**: 留空

5. 点击 **Save and Deploy** 完成首次部署

### 4.3 配置生产环境变量

部署完成后，进入该 Pages 项目 → **Settings** → **Environment variables**。

添加以下变量（勾选 **Production** 和 **Preview**）：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `VITE_FIREBASE_API_KEY` | 你的 Firebase apiKey | 必填，多人竞技实时分数 |
| `VITE_FIREBASE_DATABASE_URL` | 你的 databaseURL | 必填，多人竞技实时分数 |
| `VITE_FIREBASE_AUTH_DOMAIN` | 你的 authDomain | 可选 |
| `VITE_FIREBASE_PROJECT_ID` | 你的 projectId | 可选 |
| `VITE_FIREBASE_APP_ID` | 你的 appId | 可选 |

保存后，进入 **Deployments** → 找到最新部署 → 点击 **Retry deployment**，重新构建以注入环境变量。

---

## 五、验证部署

1. 部署完成后，Cloudflare 会给你一个地址，如：`https://xxx.pages.dev`
2. 用手机和电脑（或两个浏览器）同时访问该地址
3. 使用**同一暗号**登录，进入游戏
4. 游戏过程中，右侧 **实时榜单** 会实时显示双方分数

---

## 六、功能说明

### 多人竞技实时分数

- **按暗号分房间**：输入相同暗号的玩家在同一房间
- **实时榜单**：游戏中右侧显示当前房间内所有在线玩家的分数，按分数从高到低排序
- **自动同步**：每 2 秒同步一次，超过 15 秒未更新的玩家会从榜单中移除

### 排行榜

- **历史排行榜**：每局结束后，成绩会写入 `rooms/{暗号}/rankings`
- **大厅展示**：Dashboard 中展示该房间积分前 5 名

---

## 七、常见问题

### Q：部署后实时榜单为空？

检查 Cloudflare Pages 环境变量是否正确填写 `VITE_FIREBASE_*`，并完成 **Retry deployment** 重新构建。

### Q：Firebase 规则报错？

确保 Realtime Database 规则中 `rooms` 路径已按上文配置，且测试模式下可先放宽为：

```json
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
```

（仅用于调试，上线务必改回受限规则）

### Q：想用自定义域名？

Cloudflare Pages 项目 → **Custom domains** → **Set up a custom domain** → 按提示添加你的域名并解析。

---

## 八、总结

| 步骤 | 内容 |
|------|------|
| 1 | 创建 Firebase 项目，启用 Realtime Database |
| 2 | 获取 Firebase 配置，填入 `.env.local` |
| 3 | 本地 `npm run dev` 测试多人竞技 |
| 4 | 推送代码到 GitHub |
| 5 | Cloudflare Pages 连接仓库并部署 |
| 6 | 在 Pages 环境变量中配置 `VITE_FIREBASE_*` |
| 7 | Retry deployment 重新构建 |
| 8 | 访问线上地址，用同一暗号多人测试 |

完成以上步骤后，你的宝宝糖果消消乐即可上线，并支持多人竞技实时分数查看。
